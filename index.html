<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kalkulator KPR Dhito</title>
<link rel="manifest" href="manifest.json" />
<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
    background: linear-gradient(180deg, #1a73e8 0%, #0f4eb3 100%);
    color: #fff;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
    backdrop-filter: blur(20px);
  }
  header {
    text-align: center;
    padding: 1.2em 0;
  }
  header h1 {
    margin: 0;
    font-size: 1.8em;
    letter-spacing: 1px;
  }
  .container {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border-radius: 16px;
    width: 90%;
    max-width: 420px;
    padding: 1.5em;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    margin-bottom: 2em;
  }
  label {
    display: block;
    margin-top: 1em;
    font-size: 0.9em;
  }
  .input-group {
    position: relative;
    display: flex;
    align-items: center;
  }
  .prefix {
    position: absolute;
    left: 12px;
    color: #ddd;
    font-weight: 500;
  }
  .input-group input {
    padding-left: 35px;
    width: 100%;
    border: none;
    border-radius: 10px;
    height: 44px;
    font-size: 16px;
    margin-top: 4px;
    text-align: left;
  }
  select, button {
    width: 100%;
    height: 44px;
    font-size: 16px;
    border-radius: 10px;
    border: none;
    margin-top: 10px;
  }
  button {
    background: #fff;
    color: #0f4eb3;
    font-weight: 600;
  }
  .result {
    margin-top: 1em;
    background: rgba(255,255,255,0.2);
    border-radius: 10px;
    padding: 1em;
  }
  #adminPanel {
    display: none;
    background: rgba(255,255,255,0.2);
    padding: 10px;
    border-radius: 10px;
    margin-top: 1em;
  }
</style>
</head>
<body>
<header>
  <h1 id="logo">üè† Kalkulator KPR Dhito</h1>
</header>

<div class="container" id="mainContainer">
  <label>Harga Rumah</label>
  <div class="input-group">
    <span class="prefix">Rp</span>
    <input type="text" id="harga" inputmode="numeric" placeholder="Masukkan harga rumah" class="rupiah">
  </div>

  <label>Uang Muka</label>
  <div class="input-group">
    <span class="prefix">Rp</span>
    <input type="text" id="uangMuka" inputmode="numeric" placeholder="Masukkan uang muka" class="rupiah">
  </div>

  <label>Tenor (tahun)</label>
  <input type="number" id="tenor" placeholder="Masukkan tenor (tahun)" min="1" max="30">

  <label>Pilih Bank</label>
  <select id="bank">
    <option value="BCA">BCA</option>
    <option value="BTN">BTN</option>
    <option value="BRI">BRI</option>
    <option value="MANDIRI">Mandiri</option>
    <option value="BNI">BNI</option>
    <option value="OCBC">OCBC</option>
    <option value="BSI">BSI</option>
  </select>

  <label>Suku Bunga (%)</label>
  <input type="number" id="bunga" placeholder="Suku bunga" step="0.01">

  <button id="hitung">Hitung KPR</button>

  <div class="result" id="hasil"></div>

  <button id="shareWA">Bagikan ke WhatsApp</button>
  <button id="shareImg">Bagikan Gambar</button>

  <div id="adminPanel">
    <h3>Kelola Suku Bunga Bank</h3>
    <div id="bankList"></div>
    <button id="resetBank">Reset Default</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script>
/* === DATA BANK === */
const defaultRates = {
  BCA: 7.25, BTN: 6.9, BRI: 7.1,
  MANDIRI: 7.5, BNI: 7.4, OCBC: 7.3, BSI: 6.8
};
let bankRates = JSON.parse(localStorage.getItem('bankRates')) || defaultRates;

const bankSelect = document.getElementById('bank');
const bungaInput = document.getElementById('bunga');

bankSelect.addEventListener('change', () => {
  const bank = bankSelect.value;
  bungaInput.value = bankRates[bank];
});

/* === FORMAT RUPIAH === */
function formatRupiah(angka) {
  const numberString = angka.replace(/[^\d]/g, '');
  if (numberString === '') return '';
  return numberString.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}
function getNumericValue(str) {
  return parseInt(str.replace(/[^\d]/g, '')) || 0;
}
document.querySelectorAll('.rupiah').forEach(input => {
  input.addEventListener('input', e => {
    const cursor = input.selectionStart;
    const before = input.value.length;
    const formatted = formatRupiah(e.target.value);
    input.value = formatted;
    const after = input.value.length;
    input.setSelectionRange(cursor + (after - before), cursor + (after - before));
  });
  input.addEventListener('blur', e => {
    if (e.target.value !== '') e.target.value = 'Rp ' + e.target.value;
  });
  input.addEventListener('focus', e => {
    e.target.value = e.target.value.replace('Rp ', '');
  });
});
function getValueRupiah(id){return getNumericValue(document.getElementById(id).value);}

/* === HITUNG KPR === */
document.getElementById('hitung').addEventListener('click', ()=>{
  const harga = getValueRupiah('harga');
  const uangMuka = getValueRupiah('uangMuka');
  const bunga = parseFloat(bungaInput.value) || 0;
  const tenor = parseFloat(document.getElementById('tenor').value) || 0;
  const pinjaman = harga - uangMuka;
  const bulan = tenor * 12;
  const rate = bunga / 100 / 12;
  const angsuran = (pinjaman * rate) / (1 - Math.pow(1 + rate, -bulan));
  const totalBayar = angsuran * bulan;
  const totalBunga = totalBayar - pinjaman;

  document.getElementById('hasil').innerHTML = `
    üí∞ Pinjaman: Rp ${pinjaman.toLocaleString('id-ID')}
    <br>üìÖ Angsuran per bulan: <b>Rp ${angsuran.toLocaleString('id-ID')}</b>
    <br>üè¶ Total Bunga: Rp ${totalBunga.toLocaleString('id-ID')}
    <br>üí∏ Total Pembayaran: Rp ${totalBayar.toLocaleString('id-ID')}
  `;
});

/* === SHARE WHATSAPP === */
document.getElementById('shareWA').addEventListener('click', ()=>{
  const harga = getValueRupiah('harga').toLocaleString('id-ID');
  const uangMuka = getValueRupiah('uangMuka').toLocaleString('id-ID');
  const bunga = bungaInput.value;
  const tenor = document.getElementById('tenor').value;
  const bank = bankSelect.value;
  const hasil = document.getElementById('hasil').innerText;
  const url = "https://dhitoid.github.io/Kalkulator-KPR-Dhito/";
  const text = `üè† Simulasi KPR ‚Äî Kalkulator Dhito
Bank: ${bank}
Harga Rumah: Rp ${harga}
Uang Muka: Rp ${uangMuka}
Tenor: ${tenor} tahun
Bunga: ${bunga}%

${hasil}

Coba sendiri di üîó ${url}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
});

/* === SHARE IMAGE === */
document.getElementById('shareImg').addEventListener('click', ()=>{
  html2canvas(document.body).then(canvas=>{
    canvas.toBlob(blob=>{
      const file = new File([blob], "hasil_kpr.png", {type:"image/png"});
      if(navigator.canShare && navigator.canShare({files:[file]})){
        navigator.share({files:[file], title:"Simulasi KPR Dhito"});
      }else{
        const a=document.createElement('a');
        a.href=canvas.toDataURL();
        a.download='hasil_kpr.png';
        a.click();
      }
    });
  });
});

/* === ADMIN MODE === */
let tapCount = 0;
document.getElementById('logo').addEventListener('click', ()=>{
  tapCount++;
  if(tapCount>=3){
    tapCount=0;
    const panel=document.getElementById('adminPanel');
    panel.style.display = (panel.style.display==='block'?'none':'block');
    renderBankList();
  }
});
function renderBankList(){
  const list=document.getElementById('bankList');
  list.innerHTML='';
  Object.keys(bankRates).forEach(b=>{
    const div=document.createElement('div');
    div.innerHTML=`${b}: <input type="number" id="rate_${b}" value="${bankRates[b]}" step="0.01">`;
    list.appendChild(div);
  });
}
document.getElementById('adminPanel').addEventListener('input',e=>{
  if(e.target.id.startsWith('rate_')){
    const bank=e.target.id.replace('rate_','');
    bankRates[bank]=parseFloat(e.target.value);
    localStorage.setItem('bankRates',JSON.stringify(bankRates));
  }
});
document.getElementById('resetBank').addEventListener('click',()=>{
  bankRates=defaultRates;
  localStorage.setItem('bankRates',JSON.stringify(bankRates));
  renderBankList();
});
</script>
</body>
</html>
