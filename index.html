<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kalkulator KPR - by dhitoproperty.id</title>
  <meta name="description" content="Simulasi angsuran KPR ‚Äî Kalkulator Praktis oleh Dhito Property">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --muted:#6b7280;
      --accent:#0058d6; /* biru BCA-like */
      --accent-weak: rgba(0,88,214,0.08);
      --radius:12px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#f9fbff,#f5f7fb);-webkit-font-smoothing:antialiased;color:#0f172a}
    .topbar{background:linear-gradient(180deg,var(--accent),#0b4ab2);padding:14px 16px;color:#fff;display:flex;align-items:center;gap:12px;border-bottom-left-radius:6px;border-bottom-right-radius:6px}
    .brand{display:flex;align-items:center;gap:12px}
    .brand .logo{width:44px;height:44px;border-radius:10px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;font-weight:800}
    .brand h1{margin:0;font-size:1rem;line-height:1}
    .brand p{margin:0;font-size:0.82rem;opacity:0.92}
    .wrap{max-width:1000px;margin:14px auto;padding:12px}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns:400px 1fr}}
    .card{background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:0 10px 25px rgba(2,6,23,0.06)}
    label{display:block;font-size:0.86rem;color:var(--muted);margin-bottom:6px;font-weight:600}
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid #e6edf8;background:#fff;font-size:1rem}
    .small{font-size:0.82rem;color:var(--muted)}
    .row{display:flex;gap:10px;align-items:end}
    .row .col{flex:1}
    .btn{padding:10px 12px;border-radius:10px;background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(0,88,214,0.12)}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:0.92rem}
    th,td{padding:8px;border-bottom:1px solid #f1f7ff;text-align:right}
    th{font-weight:700;color:var(--muted);font-size:0.88rem}
    .left{text-align:left}
    input.money{text-align:right}
    .help{font-size:0.82rem;color:#475569;margin-top:8px}
    .stat{padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#f8fbff);text-align:center}
    /* responsive tweaks */
    @media(max-width:600px){
      .row{flex-direction:column;align-items:stretch}
      .topbar{padding:12px}
    }
    /* subtle form spacing */
    .form-row{margin-top:10px}
    .muted-note{font-size:0.82rem;color:#455569;margin-top:6px}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div class="logo">DP</div>
      <div>
        <h1>Kalkulator KPR</h1>
        <p>Kalkulator KPR by <strong>dhitoproperty.id</strong></p>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- LEFT: INPUT -->
      <div class="card" id="input-card">
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="flex:1">
            <label for="bank">Pilih Bank</label>
            <select id="bank" class="input" aria-label="Pilih Bank"></select>
            <div class="muted-note">Pilih bank (nama saja). Skema fixed/floating akan otomatis terisi pada kolom bunga di bawah.</div>
          </div>
        </div>

        <div class="form-row">
          <label for="price">Harga Properti</label>
          <input id="price" class="input money" inputmode="numeric" value="0" />
        </div>

        <!-- Booking Fee -->
        <div class="form-row">
          <label for="bookingFee">Booking Fee</label>
          <div style="display:flex;gap:10px">
            <input id="bookingFee" class="input money" inputmode="numeric" value="0" />
            <select id="bookingType" class="input" style="width:220px">
              <option value="price">Kurangi Harga Properti</option>
              <option value="dp">Kurangi Uang Muka (DP)</option>
              <option value="other">Kurangi Biaya Lain-lain</option>
            </select>
          </div>
          <div class="small" style="margin-top:6px">Booking fee dapat mengurangi Harga / DP / Biaya lain sesuai pilihan.</div>
        </div>

        <div class="form-row row">
          <div class="col">
            <label for="dpVal">Uang muka</label>
            <input id="dpVal" class="input money" inputmode="numeric" value="0" />
          </div>
          <div style="width:120px">
            <label for="dpPct">atau (%)</label>
            <input id="dpPct" class="input" inputmode="numeric" value="20" />
          </div>
        </div>

        <div class="form-row row">
          <div class="col">
            <label for="years">Tenor (tahun)</label>
            <select id="years" class="input">
              <option value="1">1 tahun</option>
              <option value="2">2 tahun</option>
              <option value="3">3 tahun</option>
              <option value="4">4 tahun</option>
              <option value="5">5 tahun</option>
              <option value="6">6 tahun</option>
              <option value="7">7 tahun</option>
              <option value="8">8 tahun</option>
              <option value="9">9 tahun</option>
              <option value="10">10 tahun</option>
              <option value="15" selected>15 tahun</option>
              <option value="20">20 tahun</option>
              <option value="25">25 tahun</option>
            </select>
          </div>
          <div style="width:160px">
            <label for="rate">Suku bunga (fixed %)</label>
            <input id="rate" class="input" inputmode="decimal" value="7.25" />
          </div>
        </div>

        <div class="form-row row" style="align-items:flex-end">
          <div class="col">
            <label for="floatingRate">Floating rate setelah fixed (%)</label>
            <input id="floatingRate" class="input" inputmode="decimal" value="12.00" />
            <div class="small" style="margin-top:6px">Untuk tahun setelah periode fixed.</div>
          </div>
          <div style="width:120px">
            <label for="fixedYears">Fixed (tahun)</label>
            <input id="fixedYears" class="input" inputmode="numeric" value="3" />
          </div>
        </div>

        <div class="form-row">
          <label for="interestType">Jenis bunga</label>
          <select id="interestType" class="input" aria-label="Jenis bunga">
            <option value="flat">Flat (Annuitas)</option>
            <option value="tiered" selected>Berjenjang (Tiered/Floating)</option>
          </select>
        </div>

        <div id="tierControls" class="form-row">
          <div style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="allowEditTier" />
            <label for="allowEditTier" style="margin:0;font-weight:600">Izinkan edit tier (ubah bunga tiap tahun)</label>
          </div>
        </div>

        <div id="tieredRatesContainer" class="form-row">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label style="margin:0">Bunga per tahun (%) ‚Äî (maks 25 tahun)</label>
            <button id="hideTieredBtn" class="btn ghost" style="padding:6px 8px;font-size:0.85rem">Sembunyikan Tabel</button>
          </div>
          <table id="tieredRatesTable">
            <thead><tr><th class="left">Tahun</th><th>Bunga (%)</th><th class="left">Angsuran/bln (Rp)</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="help">Default terisi berdasarkan bank dan booking fee. Centang "Izinkan edit tier" agar dapat diubah tiap tahun.</div>
        </div>

        <div class="form-row row">
          <div class="col">
            <label for="otherFees">Biaya lain (opsional)</label>
            <input id="otherFees" class="input money" inputmode="numeric" value="0" />
          </div>
          <div style="width:160px">
            <label for="extra">Pembayaran ekstra/bln</label>
            <input id="extra" class="input money" inputmode="numeric" value="0" />
          </div>
        </div>

        <div class="form-row" style="display:flex;gap:10px;align-items:center;margin-top:14px">
          <button id="calcBtn" class="btn">Hitung</button>
          <button id="resetBtn" class="btn ghost">Reset</button>
          <div style="margin-left:auto" class="small">Metode: <strong id="methodLabel">berjenjang</strong></div>
        </div>

        <div class="form-row" id="summary" style="display:none;margin-top:12px;gap:8px">
          <div class="stat" style="min-width:120px">
            <div class="small">Plafon</div>
            <div id="loanAmt" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
          <div class="stat" style="min-width:120px">
            <div class="small">Angsuran/bln</div>
            <div id="monthly" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
          <div class="stat" style="min-width:120px">
            <div class="small">Total bunga</div>
            <div id="totalInterest" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
        </div>
      </div>

      <!-- RIGHT: RESULT -->
      <div class="card" id="result-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 style="margin:0">Hasil & Amortisasi</h2>
          <div class="controls">
            <button id="exportImg" class="btn">Bagikan Gambar</button>
            <button id="downloadCsv" class="btn ghost">Ekspor CSV</button>
            <button id="shareText" class="btn ghost">Kirim ke WhatsApp</button>
          </div>
        </div>

        <div id="result-area" style="margin-top:12px">
          <canvas id="kprChart" height="320" style="width:100%;max-height:420px"></canvas>

          <div style="overflow:auto;margin-top:12px;max-height:360px">
            <table id="amortTable" aria-live="polite">
              <thead><tr><th class="left">Bulan</th><th>Saldo awal</th><th>Angsuran pokok</th><th>Bunga</th><th class="left">Saldo akhir</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <footer style="margin-top:12px">
          <div class="small">Dibuat oleh Dhito Property ¬∑ Catatan: perhitungan menggunakan rumus annuitas per periode. Hanya ilustrasi.</div>
        </footer>
      </div>
    </div>
  </div>

<script>
/* ======================
   Utility formatting
   ====================== */
function fmtRupiah(n){
  if(!isFinite(n)) return 'Rp 0';
  const sign = n < 0 ? '-' : '';
  n = Math.abs(Math.round(n));
  return sign + 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function unfmt(v){
  if (v === 0) return 0;
  if (!v) return 0;
  const clean = String(v).replace(/[^\d\-]/g, '');
  return Number(clean) || 0;
}
function formatNumberWithDots(value) {
  const num = String(value).replace(/\D/g, '');
  return num ? num.replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '';
}
function attachMoneyInputs() {
  document.querySelectorAll('.money').forEach(el => {
    if (el.value) el.value = formatNumberWithDots(el.value);
    el.addEventListener('input', () => {
      const pos = el.selectionStart;
      const before = el.value.length;
      el.value = formatNumberWithDots(el.value);
      const after = el.value.length;
      el.selectionEnd = pos + (after - before);
      // trigger tier update when price/dp/otherFees/booking change
      if (el.id === 'price' || el.id === 'dpVal' || el.id === 'otherFees' || el.id === 'bookingFee') {
        if (interestTypeEl.value === 'tiered') generateTieredTable();
      }
    });
  });
}

/* ======================
   Bank schemes (fixed + floating)
   ====================== */
const bankSchemes = {
  'BCA': { fixedYears: 3, fixedRate: 7.25, floatingRate: 12.00 },
  'BTN': { fixedYears: 5, fixedRate: 6.90, floatingRate: 11.75 },
  'MANDIRI': { fixedYears: 3, fixedRate: 7.50, floatingRate: 12.25 },
  'BRI': { fixedYears: 3, fixedRate: 7.10, floatingRate: 12.00 },
  'BNI': { fixedYears: 5, fixedRate: 7.40, floatingRate: 12.10 },
  'BSI': { fixedYears: 5, fixedRate: 6.85, floatingRate: 12.50 },
  'DEVELOPER': { fixedYears: 0, fixedRate: null, floatingRate: null }
};
const defaultBankRates = {'BCA':7.25,'BTN':6.90,'BRI':7.10,'MANDIRI':7.50,'BNI':7.40,'OCBC':7.00,'BSI':6.85,'DEVELOPER':null};
const storageKey = 'kpr_bank_rates_v2';
function loadBankRates(){ try{ const raw=localStorage.getItem(storageKey); if(!raw) return Object.assign({}, defaultBankRates); return Object.assign({}, defaultBankRates, JSON.parse(raw)); }catch(e){ return Object.assign({}, defaultBankRates); } }
function saveBankRates(map){ try{ localStorage.setItem(storageKey, JSON.stringify(map)); }catch(e){} }
let bankRates = loadBankRates();

/* ======================
   DOM refs
   ====================== */
const bankEl=document.getElementById('bank');
const priceEl=document.getElementById('price');
const bookingFeeEl=document.getElementById('bookingFee');
const bookingTypeEl=document.getElementById('bookingType');
const dpValEl=document.getElementById('dpVal');
const dpPctEl=document.getElementById('dpPct');
const yearsEl=document.getElementById('years');
const rateEl=document.getElementById('rate');
const floatingRateEl=document.getElementById('floatingRate');
const fixedYearsEl=document.getElementById('fixedYears');
const otherFeesEl=document.getElementById('otherFees');
const extraEl=document.getElementById('extra');
const calcBtn=document.getElementById('calcBtn');
const resetBtn=document.getElementById('resetBtn');
const summaryDiv=document.getElementById('summary');
const loanAmtEl=document.getElementById('loanAmt');
const monthlyEl=document.getElementById('monthly');
const totalInterestEl=document.getElementById('totalInterest');
const amortTableBody=document.querySelector('#amortTable tbody');
const downloadCsvBtn=document.getElementById('downloadCsv');
const exportImgBtn=document.getElementById('exportImg');
const shareTextBtn=document.getElementById('shareText');
const interestTypeEl = document.getElementById('interestType');
const tieredRatesContainer = document.getElementById('tieredRatesContainer');
const tieredRatesTableBody = document.getElementById('tieredRatesTable').querySelector('tbody');
const hideTieredBtn = document.getElementById('hideTieredBtn');
const allowEditTierChk = document.getElementById('allowEditTier');
const methodLabel = document.getElementById('methodLabel');

let kprChart = null;
function createChart(labels,datasets){
  const ctx=document.getElementById('kprChart');
  if(kprChart) kprChart.destroy();
  kprChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets},
    options:{
      maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:true,position:'bottom'},
        tooltip:{callbacks:{label: function(ctx){ const val=Number(ctx.raw||0); return ctx.dataset.label+': '+fmtRupiah(val); }}}
      },
      scales:{y:{ticks:{callback:v=>'Rp '+Number(v).toLocaleString('id')}}}
    }
  });
}

/* ======================
   Amortization functions
   ====================== */
function calcAmortization({principal,annualRate,months,extra=0}){
  const r=annualRate/12/100;
  let baseMonthly;
  if(!isFinite(r) || r === 0) baseMonthly = principal / months;
  else baseMonthly = (r * principal) / (1 - Math.pow(1 + r, -months));
  const schedule=[]; let bal=principal; let totalInterest=0;
  for(let m=1;m<=months&&bal>0.0001;m++){
    const interest=bal*r;
    let principalPay=baseMonthly-interest;
    principalPay += extra;
    if(principalPay>bal) principalPay=bal;
    const endBal=Math.max(0,bal-principalPay);
    schedule.push({month:m,startBalance:bal,principalPayment:principalPay,interestPayment:interest,endBalance:endBal});
    totalInterest += interest;
    bal = endBal;
  }
  const monthlyDisplay = baseMonthly + extra;
  return { schedule, monthlyPayment: monthlyDisplay, totalInterest, totalPayment: schedule.reduce((s,r)=>s + r.principalPayment + r.interestPayment,0), months: schedule.length, principal };
}

function calcTieredAmortization({principal, baseRates, years, extra=0}) {
  const schedule = [];
  let balance = principal;
  let totalInterest = 0;
  let monthCounter = 1;
  while(baseRates.length < years) baseRates.push(baseRates[baseRates.length-1] || 0);

  for (let year = 1; year <= years && balance > 0.0001; year++) {
    const rate = parseFloat(baseRates[year - 1]) || 0;
    const monthlyRate = rate / 100 / 12;
    const remainingMonths = (years - year + 1) * 12;

    let monthlyPayment;
    if (monthlyRate === 0) {
      monthlyPayment = balance / remainingMonths;
    } else {
      monthlyPayment = (monthlyRate * balance) / (1 - Math.pow(1 + monthlyRate, -remainingMonths));
    }

    for (let m = 1; m <= 12 && balance > 0.0001; m++) {
      const interest = balance * monthlyRate;
      let principalPay = monthlyPayment - interest + extra;
      if (principalPay > balance) principalPay = balance;
      const endBalance = Math.max(0, balance - principalPay);
      schedule.push({
        month: monthCounter++,
        startBalance: balance,
        principalPayment: principalPay,
        interestPayment: interest,
        endBalance,
        rate
      });
      totalInterest += interest;
      balance = endBalance;
    }
  }

  const firstMonthly = schedule.length ? (schedule[0].principalPayment + schedule[0].interestPayment) : 0;

  return {
    schedule,
    monthlyPayment: firstMonthly,
    totalInterest,
    totalPayment: schedule.reduce((s, r) => s + r.principalPayment + r.interestPayment, 0),
    months: schedule.length,
    principal
  };
}

/* ======================
   Tier preview & table generation
   ====================== */
function computeAdjustedValues(){
  const price = unfmt(priceEl.value);
  const dpVal = unfmt(dpValEl.value);
  const otherFees = unfmt(otherFeesEl.value);
  const bookingFee = unfmt(bookingFeeEl.value);
  const bookingType = bookingTypeEl.value;

  let priceAdj = price;
  let dpAdj = dpVal;
  let otherAdj = otherFees;

  if (bookingFee > 0) {
    if (bookingType === 'price') {
      priceAdj = Math.max(0, price - bookingFee);
    } else if (bookingType === 'dp') {
      dpAdj = Math.max(0, dpVal - bookingFee);
    } else if (bookingType === 'other') {
      otherAdj = Math.max(0, otherFees - bookingFee);
    }
  }
  return { price, dpVal, otherFees, priceAdj, dpAdj, otherAdj, bookingFee, bookingType };
}

function computeTieredPreview(baseRates, principal, years, extra=0){
  const preview = [];
  let balance = principal;
  const maxY = Math.min(years,25);
  for(let year=1; year<=maxY; year++){
    const ratePercent = (baseRates[year-1] != null) ? baseRates[year-1] : baseRates[baseRates.length-1];
    const yearlyRate = (parseFloat(ratePercent) || 0) / 100;
    const monthlyRate = yearlyRate / 12;
    const remainingMonths = Math.max(1, (years - year + 1) * 12);
    let monthlyPayment;
    if(!isFinite(monthlyRate) || monthlyRate === 0) monthlyPayment = balance / remainingMonths;
    else monthlyPayment = (monthlyRate * balance) / (1 - Math.pow(1 + monthlyRate, -remainingMonths));
    preview.push({ year, monthlyPayment: monthlyPayment + extra, rate: parseFloat(ratePercent)||0 });
    // simulate 12 months of payments using that monthlyPayment
    for(let m=1;m<=12 && balance>0.0001;m++){
      const interest = balance * monthlyRate;
      let principalPay = monthlyPayment - interest + extra;
      if(principalPay > balance) principalPay = balance;
      balance = Math.max(0, balance - principalPay);
    }
  }
  return preview;
}

function generateTieredTable() {
  tieredRatesTableBody.innerHTML = '';
  const years = Math.min(parseInt(yearsEl.value) || 0, 25);

  // compute adjusted principal (consider booking fee)
  const { priceAdj, dpAdj, otherAdj } = computeAdjustedValues();
  const principal = Math.max(0, priceAdj - dpAdj + otherAdj);
  const extra = unfmt(extraEl.value);

  const fixedY = parseInt(fixedYearsEl.value) || 0;
  const fixedR = parseFloat(rateEl.value) || 0;
  const floatR = parseFloat(floatingRateEl.value) || fixedR;
  const defaultRates = [];
  for (let i = 1; i <= years; i++) {
    defaultRates.push((i <= fixedY ? fixedR : floatR).toFixed(2));
  }

  const preview = computeTieredPreview(defaultRates.slice(), principal, years, extra);

  for (let i = 1; i <= years; i++) {
    const tr = document.createElement('tr');

    const tdYear = document.createElement('td');
    tdYear.textContent = i;
    tdYear.className = 'left';

    const tdRate = document.createElement('td');
    const inputRate = document.createElement('input');
    inputRate.type = 'number';
    inputRate.step = '0.01';
    inputRate.value = defaultRates[i - 1];
    inputRate.className = 'input';
    inputRate.style.width = '100px';
    inputRate.disabled = !allowEditTierChk.checked;
    tdRate.appendChild(inputRate);

    const tdAmt = document.createElement('td');
    tdAmt.className = 'left';
    const inputAmt = document.createElement('input');
    inputAmt.type = 'text';
    inputAmt.className = 'input money';
    inputAmt.value = formatNumberWithDots(Math.round(preview[i - 1]?.monthlyPayment || 0));
    inputAmt.readOnly = true;
    tdAmt.appendChild(inputAmt);

    tr.appendChild(tdYear);
    tr.appendChild(tdRate);
    tr.appendChild(tdAmt);
    tieredRatesTableBody.appendChild(tr);

    inputRate.addEventListener('input', () => {
      const rates = Array.from(tieredRatesTableBody.querySelectorAll('input[type="number"]')).map(el => parseFloat(el.value) || 0);
      const { priceAdj: pAdj, dpAdj: dAdj, otherAdj: oAdj } = computeAdjustedValues();
      const newPrincipal = Math.max(0, pAdj - dAdj + oAdj);
      const newPreview = computeTieredPreview(rates, newPrincipal, years, extra);
      Array.from(tieredRatesTableBody.querySelectorAll('input.money')).forEach((el, idx) => {
        el.value = formatNumberWithDots(Math.round(newPreview[idx]?.monthlyPayment || 0));
      });
    });
  }

  attachMoneyInputs();
}

/* ======================
   Bank apply scheme
   (dropdown shows only bank name)
   ====================== */
function populateBankSelect(){
  bankEl.innerHTML='';
  Object.keys(bankRates).forEach(k=>{
    const opt=document.createElement('option');
    opt.value=k;
    opt.textContent=k; // only name
    bankEl.appendChild(opt);
  });
}
function applyBankScheme(){
  const key = bankEl.value;
  if(!key) return;
  const scheme = bankSchemes[key];
  if(scheme){
    if(scheme.fixedRate != null) rateEl.value = scheme.fixedRate;
    if(scheme.floatingRate != null) floatingRateEl.value = scheme.floatingRate;
    if(scheme.fixedYears != null) fixedYearsEl.value = scheme.fixedYears;
  } else {
    const v = bankRates[key];
    if(v!=null) rateEl.value = v;
  }
  if(interestTypeEl.value === 'tiered') generateTieredTable();
}

/* ======================
   UI events & wiring
   ====================== */
populateBankSelect();
bankEl.value = Object.keys(bankRates)[0] || 'BCA';
applyBankScheme();
attachMoneyInputs();

bankEl.addEventListener('change', ()=>{ applyBankScheme(); });

dpPctEl.addEventListener('input', ()=>{
  const price=unfmt(priceEl.value);const pct=parseFloat(dpPctEl.value)||0;
  if(price>=0&&pct>=0){dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));}
  if(interestTypeEl.value==='tiered') generateTieredTable();
});
dpValEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value);const dp=unfmt(dpValEl.value);
  if(price>=0&&dp>=0){dpPctEl.value=((dp/price)*100).toFixed(2);}
  if(interestTypeEl.value==='tiered') generateTieredTable();
});
priceEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value);const pct=parseFloat(dpPctEl.value)||0;
  if(price>=0&&pct>=0){dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));}
  if(interestTypeEl.value==='tiered') generateTieredTable();
});

bookingFeeEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
bookingTypeEl.addEventListener('change', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });

interestTypeEl.addEventListener('change', ()=>{
  methodLabel.textContent = interestTypeEl.value === 'tiered' ? 'berjenjang' : 'annuitas';
  if(interestTypeEl.value === 'tiered'){
    generateTieredTable();
    tieredRatesContainer.style.display = 'block';
  } else {
    tieredRatesContainer.style.display = 'none';
  }
});

yearsEl.addEventListener('change', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
fixedYearsEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
rateEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
floatingRateEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
otherFeesEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
extraEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });

allowEditTierChk.addEventListener('change', ()=>{
  if(interestTypeEl.value === 'tiered') generateTieredTable();
});

hideTieredBtn.addEventListener('click',(e)=>{ e.preventDefault(); tieredRatesContainer.style.display='none'; interestTypeEl.value='flat'; methodLabel.textContent='annuitas'; });

/* ======================
   Calculate & render
   ====================== */
function renderResults(res, meta){
  summaryDiv.style.display='flex';
  loanAmtEl.textContent = fmtRupiah(res.principal || 0);
  monthlyEl.textContent = fmtRupiah(res.monthlyPayment || 0);
  totalInterestEl.textContent = fmtRupiah(res.totalInterest || 0);
  amortTableBody.innerHTML = '';
  const labels=[], balSeries=[], interestSeries=[], principalSeries=[];
  res.schedule.forEach(row=>{
    labels.push(String(row.month));
    balSeries.push(Math.round(row.endBalance));
    interestSeries.push(Math.round(row.interestPayment));
    principalSeries.push(Math.round(row.principalPayment));
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="left">#${row.month}</td><td>${fmtRupiah(row.startBalance)}</td><td>${fmtRupiah(row.principalPayment)}</td><td>${fmtRupiah(row.interestPayment)}</td><td class="left">${fmtRupiah(row.endBalance)}</td>`;
    amortTableBody.appendChild(tr);
  });
  createChart(labels,[
    {label:'Saldo akhir (Rp)',data:balSeries,borderWidth:3,tension:0.2},
    {label:'Bunga/bln (Rp)',data:interestSeries,borderWidth:2,tension:0.2},
    {label:'Pokok/bln (Rp)',data:principalSeries,borderWidth:2,tension:0.2}
  ]);
}

    /* Main calculate handler */
    function handleCalculate(){
      const { price, dpVal, otherFees, priceAdj, dpAdj, otherAdj, bookingFee, bookingType } = computeAdjustedValues();
      const dpPct = parseFloat(dpPctEl.value) || 0;
      const years = parseInt(yearsEl.value) || 0;
      const rate = parseFloat(rateEl.value) || 0;
      const extra = unfmt(extraEl.value);
      let dp = dpAdj;
      if(!dp && dpPct && priceAdj) dp = Math.round(priceAdj * dpPct / 100);
      if(priceAdj && dp) dpPctEl.value = (dp / Math.max(1, priceAdj) * 100).toFixed(2);
    
      const principal = Math.max(0, priceAdj - dp + otherAdj);
      const months = years * 12;
      if(principal<=0||months<=0){ alert("Pastikan semua input (harga, tenor, dll.) diisi dengan benar."); return; }
    
      let res;
      let baseRatesForResult = null;
      if(interestTypeEl.value === 'flat'){
        res = calcAmortization({ principal, annualRate: rate, months, extra });
        baseRatesForResult = Array(years).fill(rate);
      } else {
        const inputs = tieredRatesTableBody.querySelectorAll('input[type="number"]');
        let baseRates;
        if(inputs && inputs.length >= years){
          baseRates = Array.from(inputs).map(i=>parseFloat(i.value) || rate);
        } else {
          const fixedY = parseInt(fixedYearsEl.value) || 0;
          const floatR = parseFloat(floatingRateEl.value) || rate;
          baseRates = [];
          for(let y=1;y<=years;y++){
            baseRates.push(y <= fixedY ? rate : floatR);
          }
        }
        while(baseRates.length < years) baseRates.push(baseRates[baseRates.length-1] || rate);
        baseRatesForResult = baseRates.slice(0, years);
        res = calcTieredAmortization({ principal, baseRates, years, extra });
      }
      res.principal = principal;
    
      renderResults(res);
      window._lastResult = {
        inputs:{
          originalPrice: price,
          priceAdjusted: priceAdj,
          originalDp: dpVal,
          dpAdjusted: dpAdj,
          bookingFee,
          bookingType,
          years, rate, otherFees, otherAdjusted: otherAdj,
          bank: bankEl.value,
          interestType: interestTypeEl.value,
          baseRates: baseRatesForResult,
          monthlyPreview: res.monthlyPayment
        },
        summary: { monthly: res.monthlyPayment, totalInterest: res.totalInterest, totalPayment: res.totalPayment, schedule: res.schedule }
      };
    }
    
    /* events */
    calcBtn.addEventListener('click', handleCalculate);
    
    resetBtn.addEventListener('click', ()=>{
      priceEl.value='0'; bookingFeeEl.value='0'; bookingTypeEl.value='price';
      dpValEl.value='0'; dpPctEl.value='20';
      yearsEl.value='15'; bankRates = loadBankRates(); populateBankSelect(); bankEl.value='BCA'; applyBankScheme();
      otherFeesEl.value='0'; extraEl.value='0';
      interestTypeEl.value='tiered'; methodLabel.textContent='berjenjang'; tieredRatesContainer.style.display='block';
      summaryDiv.style.display='none'; amortTableBody.innerHTML=''; if(kprChart) kprChart.destroy();
      if(interestTypeEl.value==='tiered') generateTieredTable();
    });
    
    /* ======================
       CSV / share / export
       ====================== */
    downloadCsvBtn.addEventListener('click', ()=>{
      const rows = Array.from(amortTableBody.querySelectorAll('tr'));
      if(rows.length === 0){ alert('Tidak ada data. Silakan hitung terlebih dahulu.'); return; }
      const header = ['Bulan','Saldo awal','Angsuran pokok','Bunga','Saldo akhir'];
      const lines = [header.join(',')];
      rows.forEach(r=>{
        const tds = r.querySelectorAll('td');
        const month = tds[0].textContent.replace(/[^0-9]/g,'');
        const start = fmtRupiah(unfmt(tds[1].textContent));
        const pokok = fmtRupiah(unfmt(tds[2].textContent));
        const bunga = fmtRupiah(unfmt(tds[3].textContent));
        const end = fmtRupiah(unfmt(tds[4].textContent));
        lines.push([month,start,pokok,bunga,end].join(','));
      });
      const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'amortisasi_kpr.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    
    exportImgBtn.addEventListener('click', async ()=>{
      if(!window._lastResult){ alert('Silakan hitung terlebih dahulu.'); return; }
      try {
        const container = document.createElement('div');
        container.style.padding='18px'; container.style.background='#fff'; container.style.width='900px'; container.style.boxSizing='border-box';
        const inputs = window._lastResult.inputs;
        container.innerHTML = `<h3 style="margin:0 0 10px 0">Simulasi KPR ‚Äî ${inputs.bank}</h3>
          <div style="margin-bottom:10px">
            <div>Harga (after booking): ${fmtRupiah(inputs.priceAdjusted || inputs.originalPrice || 0)}</div>
            <div>DP (after booking): ${fmtRupiah(inputs.dpAdjusted || inputs.originalDp || 0)}</div>
            <div>Pinjaman: ${fmtRupiah((inputs.priceAdjusted || inputs.originalPrice || 0) - (inputs.dpAdjusted || inputs.originalDp || 0) + (inputs.otherAdjusted||0))}</div>
            <div>Angsuran/bln (preview): ${fmtRupiah(window._lastResult.summary.monthly || 0)}</div>
            <div>Total bunga: ${fmtRupiah(window._lastResult.summary.totalInterest || 0)}</div>
          </div><div id="miniChartWrap" style="width:100%;height:260px"></div>`;
        document.body.appendChild(container);
        const miniCanvas = document.createElement('canvas');
        miniCanvas.width = 900; miniCanvas.height=260;
        container.querySelector('#miniChartWrap').appendChild(miniCanvas);
        const chartData = kprChart ? kprChart.data : { labels: [], datasets: [] };
        const miniChart = new Chart(miniCanvas.getContext('2d'), { type:'line', data: chartData, options:{ responsive:false, plugins:{ legend:{display:false} } }});
        const canvas = await html2canvas(container, { scale:2, useCORS:true, backgroundColor:'#fff' });
        miniChart.destroy(); container.remove();
        canvas.toBlob(async blob=>{
          if(!blob) return alert('Gagal membuat gambar.');
          const file = new File([blob], 'hasil_kpr.png', { type:'image/png' });
          if(navigator.canShare && navigator.canShare({ files: [file] })){
            try { await navigator.share({ files: [file], title: 'Hasil Simulasi KPR', text: 'Simulasi KPR ‚Äî Kalkulator Praktis' }); return; } catch(e){}
          }
          const url = canvas.toDataURL('image/png');
          const win = window.open();
          if(win){ win.document.write('<title>Hasil Simulasi</title><img src="'+url+'" style="width:100%;">'); }
          else { const a = document.createElement('a'); a.href=url; a.download='hasil_kpr.png'; a.click(); }
        }, 'image/png', 0.95);
      } catch(err){ console.error(err); alert('Gagal membuat gambar hasil. Gunakan browser terbaru (Chrome/Edge/Safari).'); }
    });
    
    shareTextBtn.addEventListener('click', ()=>{
      const d = window._lastResult;
      if(!d){ alert('Silakan hitung terlebih dahulu.'); return; }
      let txt = `üè† Simulasi KPR ‚Äî ${d.inputs.bank}\nHarga (after booking): ${fmtRupiah(d.inputs.priceAdjusted || d.inputs.originalPrice)}\nUang muka (after booking): ${fmtRupiah(d.inputs.dpAdjusted || d.inputs.originalDp)}\nTenor: ${d.inputs.years} tahun\n`;
      if(d.inputs.interestType === 'flat'){
        txt += `Suku bunga: ${d.inputs.rate}% (Flat)\nAngsuran/bln: ${fmtRupiah(d.summary.monthly)}\nTotal bunga: ${fmtRupiah(d.summary.totalInterest)}\nTotal bayar: ${fmtRupiah(d.summary.totalPayment)}\n`;
      } else {
        txt += `Jenis: Berjenjang (Floating)\n\n`;
        const schedule = d.summary.schedule || [];
        const years = d.inputs.years;
        const baseRates = d.inputs.baseRates || [];
        for(let y=1;y<=Math.min(years,25);y++){
          const startMonthIndex = (y-1)*12;
          if(startMonthIndex >= schedule.length) break;
          const row = schedule[startMonthIndex];
          const rateVal = (baseRates[y-1] != null) ? baseRates[y-1] : (baseRates[baseRates.length-1] || d.inputs.rate);
          const monthly = row ? (row.principalPayment + row.interestPayment) : 0;
          txt += `Tahun ${y}: ${Number(rateVal).toFixed(2)}% ‚Üí ${fmtRupiah(monthly)} /bln\n`;
        }
        txt += `\nTotal bunga: ${fmtRupiah(d.summary.totalInterest)}\nTotal bayar: ${fmtRupiah(d.summary.totalPayment)}\n`;
      }
      txt += `\nDibuat oleh Kalkulator Praktis ‚Äî dhitoproperty.id`;
      const waUrl = 'https://wa.me/?text=' + encodeURIComponent(txt);
      window.open(waUrl, '_blank');
    });
    
    /* Initialize table at load if tiered selected */
    document.addEventListener('DOMContentLoaded', ()=>{
      if(interestTypeEl.value==='tiered') generateTieredTable();
      attachMoneyInputs();
    });
    
    /* ======== PATCH OPTIMASI ANTI-LAG ========= */

/* Debounce versi global */
const debouncedCalculate = debounce(handleCalculate, 250);
const debouncedApplyBank = debounce(applyBankScheme, 200);
const debouncedGenerateTiered = debounce(generateTieredTable, 200);

/* Override event berat */
calcBtn.removeEventListener('click', handleCalculate);
calcBtn.addEventListener('click', debouncedCalculate);

bankEl.removeEventListener('change', applyBankScheme);
bankEl.addEventListener('change', debouncedApplyBank);

/* Saat input angka ‚Üí jangan render langsung */
[
  priceEl, dpValEl, dpPctEl, yearsEl, rateEl,
  bookingFeeEl, otherFeesEl, extraEl
].forEach(el=>{
  el.addEventListener("input", debounce(function(){

      // format angka tanpa ngefreeze UI
      if (this.classList.contains("money")) {
          let raw = this.value.replace(/\./g, "");
          this.value = Number(raw || 0).toLocaleString("id-ID");
      }

      // AMBIL TABEL HANYA SEKALI setelah user selesai ketik
      if (interestTypeEl.value === "tiered") {
          generateTieredTable();
      }

  }, 350)); // 350ms ‚Üí user ketik cepat = smooth
});

    </script>
    </body>
    </html>
    