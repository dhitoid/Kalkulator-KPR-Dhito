<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Kalkulator Praktis</title>
  <meta name="description" content="Simulasi angsuran KPR ‚Äî Kalkulator Praktis oleh Dhito Property">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
  :root {
    --bg: #f5f7fb;
    --card: rgba(255, 255, 255, 0.9);
    --muted: #707b8a;
    --accent: #007aff;
    --radius-lg: 18px;
    --shadow: 0 10px 30px rgba(2,6,23,0.06);
    --blur-bg: blur(14px);
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  * { box-sizing: border-box; }

  html, body {
    height: 100%;
    margin: 0;
    background: linear-gradient(180deg, #f9fbff 0%, var(--bg) 100%);
    -webkit-font-smoothing: antialiased;
  }

  .wrap {
    max-width: 980px;
    margin: 20px auto;
    padding: 12px;
  }

  header {
    display: flex;
    gap: 14px;
    align-items: center;
    margin-bottom: 18px;
    backdrop-filter: var(--blur-bg);
  }

  .app-icon {
    width: 56px;
    height: 56px;
    border-radius: 14px;
    background: var(--accent);
    display: flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    font-weight: 700;
    font-size: 26px;
    box-shadow: 0 10px 24px rgba(0,122,255,0.18);
    overflow: hidden;
    flex-shrink: 0;
  }

  .app-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    border-radius: 12px;
  }

  .app-title {
    display: flex;
    flex-direction: column;
  }

  .app-title h1 {
    font-size: 1.15rem;
    margin: 0;
    color: #0f172a;
    font-weight: 700;
  }

  .app-title .muted {
    color: var(--muted);
    font-size: 0.92rem;
    margin-top: 3px;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 14px;
  }

  @media(min-width:920px){
    .grid { grid-template-columns: 380px 1fr; }
  }

  .card {
    background: var(--card);
    border-radius: var(--radius-lg);
    padding: 16px;
    box-shadow: var(--shadow);
    backdrop-filter: var(--blur-bg);
    border: 1px solid rgba(255,255,255,0.6);
    transition: transform .18s ease, box-shadow .18s ease;
  }

  .card:hover {
    transform: translateY(-3px);
    box-shadow: 0 14px 36px rgba(2,6,23,0.09);
  }

  label {
    display: block;
    font-size: 0.86rem;
    color: var(--muted);
    margin-bottom: 6px;
    font-weight: 600;
  }

  .input {
    width: 100%;
    padding: 12px;
    border-radius: 12px;
    border: 1px solid #e6edf8;
    font-size: 1rem;
    background: linear-gradient(180deg, #fff, #fbfdff);
    transition: box-shadow .15s, border-color .15s;
  }

  .input:focus {
    outline: none;
    box-shadow: 0 6px 20px rgba(0,122,255,0.08);
    border-color: var(--accent);
  }

  .row { display: flex; gap: 10px; }

  .btn {
    padding: 10px 14px;
    border-radius: 12px;
    background: var(--accent);
    color: #fff;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: transform .12s, opacity .12s;
  }

  .btn:hover { transform: translateY(-1px); opacity: .96; }

  .btn.ghost {
    background: transparent;
    color: var(--accent);
    border: 1px solid rgba(0,122,255,0.12);
  }

  .small { font-size: 0.82rem; color: var(--muted); }

  .stats {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .stat {
    flex: 1;
    min-width: 140px;
    padding: 12px;
    border-radius: 12px;
    background: linear-gradient(180deg, #fff, #f8fbff);
    box-shadow: inset 0 -1px 0 rgba(0,0,0,0.03);
    text-align: center;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.88rem;
    margin-top: 10px;
  }

  th, td {
    padding: 10px;
    border-bottom: 1px solid #eef6ff;
    text-align: right;
  }

  th { background: transparent; color: var(--muted); font-weight: 700; }

  .left { text-align: left; }

  /* === TABEL BUNGA BERJENJANG ‚Äì versi FIXED (tanpa scroll) === */
  #tieredRatesTable {
    width: 100%;
    border-collapse: collapse;
    margin-top: 6px;
    table-layout: fixed; /* biar kolom auto menyesuaikan */
  }

  #tieredRatesTable th,
  #tieredRatesTable td {
    padding: 6px 6px;
    border-bottom: 1px solid #f1f6ff;
    vertical-align: middle;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #tieredRatesTable th.left,
  #tieredRatesTable td.left { text-align: left; }

  /* Kolom lebar tiap tipe */
  #tieredRatesTable th:nth-child(1),
  #tieredRatesTable td:nth-child(1) { width: 16%; }  /* Tahun */
  #tieredRatesTable th:nth-child(2),
  #tieredRatesTable td:nth-child(2) { width: 28%; }  /* Bunga (%) */
  #tieredRatesTable th:nth-child(3),
  #tieredRatesTable td:nth-child(3) { width: 56%; }  /* Angsuran */

  /* Input bunga */
  #tieredRatesTable input.input {
    padding: 6px 6px;
    height: 34px;
    width: 100%;
    font-size: 0.95rem;
    text-align: right;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    background: linear-gradient(180deg,#fff,#fbfdff);
    box-sizing: border-box;
  }

  /* Kolom Angsuran */
  #tieredRatesTable .amt {
    text-align: right;
    display: inline-block;
    width: 100%;
    font-weight: 600;
    font-family: ui-monospace, monospace;
    white-space: nowrap;
  }

  #tieredRatesTable input.input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 4px rgba(0,122,255,0.2);
  }

  #tieredRatesTable th {
    font-size: 0.85rem;
    color: var(--muted);
    font-weight: 700;
  }

  #tieredRatesContainer > div:first-child {
    margin-bottom: 4px;
  }

  @media (max-width: 480px) {
    #tieredRatesTable th:nth-child(1),
    #tieredRatesTable td:nth-child(1) { width: 18%; }
    #tieredRatesTable th:nth-child(2),
    #tieredRatesTable td:nth-child(2) { width: 30%; }
    #tieredRatesTable th:nth-child(3),
    #tieredRatesTable td:nth-child(3) { width: 52%; }
    
    #tieredRatesTable input.input {
      font-size: 0.9rem;
      padding: 5px 6px;
    }
  }

  /* Modal */
  .modal {
    position: fixed;
    inset: 0;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(10,20,40,0.45);
    z-index: 9999;
  }

  .modal .inner {
    background: #fff;
    padding: 16px;
    border-radius: 12px;
    width: 92%;
    max-width: 520px;
    box-shadow: 0 20px 60px rgba(2,6,23,0.4);
  }

  .bank-row { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
  .bank-row input { flex: 1; }

  .help { font-size: 0.8rem; color: #475569; margin-top: 8px; }

  @media(max-width:480px){
    header{gap:10px}
    .app-title h1{font-size:1rem}
    .card{padding:12px}
    .app-icon{width:48px;height:48px}
  }
</style>

</head>
<body>
  <div class="wrap">
    <header>
      <div id="logo" class="app-icon" title="Ketuk 3x untuk admin">
        <img src="https://raw.githubusercontent.com/dhitoid/Kalkulator-KPR-Dhito/main/assets/modernia.png" alt="Logo Dhito Property" />
      </div>
      <div class="app-title">
        <h1>Kalkulator By Dhito Property</h1>
        <div class="muted">Simulasi angsuran</div>
      </div>
    </header>

    <div class="grid">
      <div class="card" id="input-card">
        <label for="bank">Pilih Bank</label>
        <select id="bank" class="input" aria-label="Pilih Bank"></select>

        <div style="display:flex;gap:8px;margin-top:12px">
          <div style="flex:1">
            <label for="price">Harga Properti</label>
            <input id="price" class="input money" inputmode="numeric" value="0" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1">
            <label for="dpVal">Uang muka</label>
            <input id="dpVal" class="input money" inputmode="numeric" value="0" />
          </div>
          <div style="width:120px">
            <label for="dpPct">atau (%)</label>
            <input id="dpPct" class="input" inputmode="numeric" value="0" />
          </div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1">
            <label for="years">Tenor (tahun)</label>
            <input id="years" class="input" inputmode="numeric" type="number" min="1" max="30" value="15" />
          </div>
          <div style="width:160px">
            <label for="rate">Suku bunga (% per tahun)</label>
            <input id="rate" class="input" inputmode="decimal" value="7.25" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label for="interestType">Jenis bunga</label>
          <select id="interestType" class="input" aria-label="Jenis bunga">
            <option value="flat" selected>Flat (Tetap)</option>
            <option value="tiered">Berjenjang (Floating)</option>
          </select>
        </div>

        <div id="tieredRatesContainer" style="display:none;margin-top:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <label style="margin:0">Bunga per tahun (%) ‚Äî (maks 25 tahun)</label>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="hideTieredBtn" class="btn ghost" style="padding:6px 10px;font-size:0.85rem">Sembunyikan Tabel</button>
            </div>
          </div>
          <table id="tieredRatesTable">
            <thead><tr><th class="left">Tahun</th><th>Bunga (%)</th><th class="left">Angsuran/bln (Rp)</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="help">Edit nilai bunga tiap tahun. Jika tenor > 25, sisa tahun pakai bunga tahun ke-25.</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px">
          <div style="flex:1">
            <label for="otherFees">Biaya lain (opsional)</label>
            <input id="otherFees" class="input money" inputmode="numeric" value="0" />
          </div>
          <div style="width:160px">
            <label for="extra">Pembayaran ekstra/bln</label>
            <input id="extra" class="input money" inputmode="numeric" value="0" />
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:14px;align-items:center">
          <button id="calcBtn" class="btn">Hitung</button>
          <button id="resetBtn" class="btn ghost">Reset</button>
          <div style="margin-left:auto" class="small">Metode: <strong id="methodLabel">annuitas</strong></div>
        </div>

        <div class="stats" id="summary" style="display:none">
          <div class="stat">
            <div class="small">Plafon</div>
            <div id="loanAmt" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
          <div class="stat">
            <div class="small">Angsuran/bln</div>
            <div id="monthly" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
          <div class="stat">
            <div class="small">Total bunga</div>
            <div id="totalInterest" style="font-size:1.05rem;font-weight:800">Rp 0</div>
          </div>
        </div>

        <div class="help">Tips: ketuk logo di atas 3x untuk mengubah suku bunga bank.</div>
      </div>

      <div class="card" id="result-card">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
          <h2 style="margin:0">Hasil & Amortisasi</h2>
          <div class="controls">
            <button id="exportImg" class="btn">Bagikan Gambar</button>
            <button id="downloadCsv" class="btn ghost">Ekspor CSV</button>
            <button id="shareText" class="btn ghost">Kirim ke WhatsApp</button>
          </div>
        </div>

        <div id="result-area" style="margin-top:12px">
          <canvas id="kprChart" height="320" style="width:100%;max-height:420px"></canvas>

          <div style="overflow:auto;margin-top:12px;max-height:280px">
            <table id="amortTable" aria-live="polite">
              <thead><tr><th class="left">Bulan</th><th>Saldo awal</th><th>Angsuran pokok</th><th>Bunga</th><th class="left">Saldo akhir</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <footer style="margin-top:12px">
          <div class="small">Dibuat oleh Dhito Property ¬∑ Catatan: perhitungan menggunakan rumus annuitas. Hasil aktual dapat berbeda.</div>
        </footer>
      </div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="inner">
      <h3>Kelola Suku Bunga Bank</h3>
      <div id="bankList"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="saveBanks" class="btn">Simpan</button>
        <button id="resetBanks" class="btn ghost">Reset Default</button>
        <button id="closeModal" class="btn ghost">Tutup</button>
      </div>
      <div class="help">Perubahan tersimpan dan berlaku saat Anda mengakses situs dari perangkat ini.</div>
    </div>
  </div>

<script>
function fmtRupiah(n){
  if(!isFinite(n)) return 'Rp 0';
  const sign = n < 0 ? '-' : '';
  n = Math.abs(Math.round(n));
  return sign + 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function unfmt(v){
  if (v === 0) return 0;
  if (!v) return 0;
  const clean = String(v).replace(/[^\d\-]/g, '');
  return Number(clean) || 0;
}
function formatNumberWithDots(value) {
  const num = String(value).replace(/\D/g, '');
  return num ? num.replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '';
}
function attachMoneyInputs() {
  document.querySelectorAll('.money').forEach(el => {
    if (el.value) el.value = formatNumberWithDots(el.value);
    el.addEventListener('input', () => {
      const pos = el.selectionStart;
      const before = el.value.length;
      el.value = formatNumberWithDots(el.value);
      const after = el.value.length;
      el.selectionEnd = pos + (after - before);
    });
  });
}
const defaultBankRates = {'BCA':7.25,'BTN':6.90,'BRI':7.10,'MANDIRI':7.50,'BNI':7.40,'OCBC':7.00,'BSI':6.85,'DEVELOPER':null};
const storageKey = 'kpr_bank_rates_v2';
function loadBankRates(){ try{ const raw=localStorage.getItem(storageKey); if(!raw) return Object.assign({}, defaultBankRates); return Object.assign({}, defaultBankRates, JSON.parse(raw)); }catch(e){ return Object.assign({}, defaultBankRates); } }
function saveBankRates(map){ try{ localStorage.setItem(storageKey, JSON.stringify(map)); }catch(e){} }
let bankRates = loadBankRates();
const bankEl=document.getElementById('bank');
const priceEl=document.getElementById('price');
const dpValEl=document.getElementById('dpVal');
const dpPctEl=document.getElementById('dpPct');
const yearsEl=document.getElementById('years');
const rateEl=document.getElementById('rate');
const otherFeesEl=document.getElementById('otherFees');
const extraEl=document.getElementById('extra');
const calcBtn=document.getElementById('calcBtn');
const resetBtn=document.getElementById('resetBtn');
const summaryDiv=document.getElementById('summary');
const loanAmtEl=document.getElementById('loanAmt');
const monthlyEl=document.getElementById('monthly');
const totalInterestEl=document.getElementById('totalInterest');
const amortTableBody=document.querySelector('#amortTable tbody');
const downloadCsvBtn=document.getElementById('downloadCsv');
const exportImgBtn=document.getElementById('exportImg');
const shareTextBtn=document.getElementById('shareText');
const logo=document.getElementById('logo');
const modal=document.getElementById('modal');
const bankList=document.getElementById('bankList');
const saveBanksBtn=document.getElementById('saveBanks');
const resetBanksBtn=document.getElementById('resetBanks');
const closeModalBtn=document.getElementById('closeModal');
const resultArea=document.getElementById('result-area');
const interestTypeEl = document.getElementById('interestType');
const tieredRatesContainer = document.getElementById('tieredRatesContainer');
const tieredRatesTableBody = document.getElementById('tieredRatesTable').querySelector('tbody');
const hideTieredBtn = document.getElementById('hideTieredBtn');
const methodLabel = document.getElementById('methodLabel');

let kprChart = null;
function createChart(labels,datasets){
  const ctx=document.getElementById('kprChart');
  if(kprChart) kprChart.destroy();
  kprChart=new Chart(ctx,{
    type:'line',
    data:{labels,datasets},
    options:{
      maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:true,position:'bottom'},
        tooltip:{callbacks:{label: function(ctx){ const val=Number(ctx.raw||0); return ctx.dataset.label+': '+fmtRupiah(val); }}}
      },
      scales:{y:{ticks:{callback:v=>'Rp '+Number(v).toLocaleString('id')}}}
    }
  });
}

function calcAmortization({principal,annualRate,months,extra=0}){
  const r=annualRate/12/100;
  let baseMonthly;
  if(!isFinite(r) || r === 0) baseMonthly = principal / months;
  else baseMonthly = (r * principal) / (1 - Math.pow(1 + r, -months));
  const schedule=[]; let bal=principal; let totalInterest=0;
  for(let m=1;m<=months&&bal>0.0001;m++){
    const interest=bal*r;
    let principalPay=baseMonthly-interest;
    principalPay += extra;
    if(principalPay>bal) principalPay=bal;
    const endBal=Math.max(0,bal-principalPay);
    schedule.push({month:m,startBalance:bal,principalPayment:principalPay,interestPayment:interest,endBalance:endBal});
    totalInterest += interest;
    bal = endBal;
  }
  const monthlyDisplay = baseMonthly + extra;
  return { schedule, monthlyPayment: monthlyDisplay, totalInterest, totalPayment: schedule.reduce((s,r)=>s + r.principalPayment + r.interestPayment,0), months: schedule.length, principal };
}

function calcTieredAmortization({principal, baseRates, years, extra=0}){
  const schedule=[]; let balance=principal; let totalInterest=0; let monthCounter=1;
  for(let year=1; year<=years && balance>0.0001; year++){
    const ratePercent = (baseRates[year-1] != null) ? baseRates[year-1] : baseRates[baseRates.length-1];
    const yearlyRate = (parseFloat(ratePercent) || 0) / 100;
    const monthlyRate = yearlyRate / 12;
    const monthsInYear = 12;
    const remainingMonths = Math.max(1, (years - year + 1) * 12);
    let monthlyPayment;
    if(!isFinite(monthlyRate) || monthlyRate === 0) monthlyPayment = balance / remainingMonths;
    else monthlyPayment = (monthlyRate * balance) / (1 - Math.pow(1 + monthlyRate, -remainingMonths));
    for(let m=1;m<=monthsInYear && balance>0.0001;m++){
      const interest = balance * monthlyRate;
      let principalPay = monthlyPayment - interest + extra;
      if(principalPay > balance) principalPay = balance;
      const endBalance = Math.max(0, balance - principalPay);
      schedule.push({ month: monthCounter++, startBalance: balance, principalPayment: principalPay, interestPayment: interest, endBalance });
      totalInterest += interest;
      balance = endBalance;
    }
  }
  return { schedule, monthlyPayment: schedule.length ? (schedule[0].principalPayment + schedule[0].interestPayment) : 0, totalInterest, totalPayment: schedule.reduce((s,r)=>s + r.principalPayment + r.interestPayment,0), months: schedule.length, principal };
}

function renderResults(res){
  summaryDiv.style.display='flex';
  loanAmtEl.textContent = fmtRupiah(res.principal || 0);
  monthlyEl.textContent = fmtRupiah(res.monthlyPayment || 0);
  totalInterestEl.textContent = fmtRupiah(res.totalInterest || 0);
  amortTableBody.innerHTML = '';
  const labels=[], balSeries=[], interestSeries=[], principalSeries=[];
  res.schedule.forEach(row=>{
    labels.push(String(row.month));
    balSeries.push(Math.round(row.endBalance));
    interestSeries.push(Math.round(row.interestPayment));
    principalSeries.push(Math.round(row.principalPayment));
    const tr=document.createElement('tr');
    tr.innerHTML = `<td class="left">#${row.month}</td><td>${fmtRupiah(row.startBalance)}</td><td>${fmtRupiah(row.principalPayment)}</td><td>${fmtRupiah(row.interestPayment)}</td><td class="left">${fmtRupiah(row.endBalance)}</td>`;
    amortTableBody.appendChild(tr);
  });
  createChart(labels,[
    {label:'Saldo akhir (Rp)',data:balSeries,borderWidth:3,tension:0.2},
    {label:'Bunga/bln (Rp)',data:interestSeries,borderWidth:2,tension:0.2},
    {label:'Pokok/bln (Rp)',data:principalSeries,borderWidth:2,tension:0.2}
  ]);
}

function populateBankSelect(){
  bankEl.innerHTML='';
  Object.keys(bankRates).forEach(k=>{
    const opt=document.createElement('option');
    opt.value=k;
    const val=bankRates[k];
    opt.textContent=k + (val != null ? ' ‚Äî ' + val + '%' : (k === 'DEVELOPER' ? ' ‚Äî Developer' : ''));
    bankEl.appendChild(opt);
  });
}
function updateRateFromBank(){ const v = bankRates[bankEl.value]; if(v==null){ rateEl.removeAttribute('readonly'); } else { rateEl.value = v; rateEl.setAttribute('readonly','true'); } }
populateBankSelect(); updateRateFromBank(); bankEl.addEventListener('change', updateRateFromBank);
attachMoneyInputs();

dpPctEl.addEventListener('input', ()=>{
  const price=unfmt(priceEl.value);const pct=parseFloat(dpPctEl.value)||0;
  if(price>=0&&pct>=0){dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));}
});
dpValEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value);const dp=unfmt(dpValEl.value);
  if(price>=0&&dp>=0){dpPctEl.value=((dp/price)*100).toFixed(2);}
});
priceEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value);const pct=parseFloat(dpPctEl.value)||0;
  if(price>=0&&pct>=0){dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));}
});

function computeTieredPreview(baseRates, principal, years, extra=0){
  const preview = [];
  let balance = principal;
  const maxY = Math.min(years,25);
  for(let year=1; year<=maxY; year++){
    const ratePercent = (baseRates[year-1] != null) ? baseRates[year-1] : baseRates[baseRates.length-1];
    const yearlyRate = (parseFloat(ratePercent) || 0) / 100;
    const monthlyRate = yearlyRate / 12;
    const remainingMonths = Math.max(1, (years - year + 1) * 12);
    let monthlyPayment;
    if(!isFinite(monthlyRate) || monthlyRate === 0) monthlyPayment = balance / remainingMonths;
    else monthlyPayment = (monthlyRate * balance) / (1 - Math.pow(1 + monthlyRate, -remainingMonths));
    // This monthlyPayment is the payment that will be applied for the coming months (bank-like recalculation)
    preview.push({ year, monthlyPayment: monthlyPayment + extra, rate: parseFloat(ratePercent)||0 });
    // simulate 12 months of payments using that monthlyPayment
    for(let m=1;m<=12 && balance>0.0001;m++){
      const interest = balance * monthlyRate;
      let principalPay = monthlyPayment - interest + extra;
      if(principalPay > balance) principalPay = balance;
      balance = Math.max(0, balance - principalPay);
    }
  }
  return preview;
}

function generateTieredTable() {
  const years = Math.min(parseInt(yearsEl.value) || 0, 25);
  const baseRate = parseFloat(rateEl.value) || 0;
  tieredRatesTableBody.innerHTML = '';

  const principal = Math.max(0, unfmt(priceEl.value) - unfmt(dpValEl.value) + unfmt(otherFeesEl.value));
  const extra = unfmt(extraEl.value);

  const defaultRates = [];
  for (let i = 1; i <= years; i++) defaultRates.push((baseRate + (i - 1) * 0.25).toFixed(2));

  const preview = computeTieredPreview(defaultRates, principal, years, extra);

  for (let i = 1; i <= years; i++) {
    const tr = document.createElement('tr');

    // === Tahun ===
    const tdYear = document.createElement('td');
    tdYear.textContent = i;
    tdYear.className = 'left';

    // === Bunga ===
    const tdRate = document.createElement('td');
    const inputRate = document.createElement('input');
    inputRate.type = 'number';
    inputRate.step = '0.01';
    inputRate.value = defaultRates[i - 1];
    inputRate.className = 'input';
    inputRate.style.width = '90px';
    tdRate.appendChild(inputRate);

    // === Angsuran ===
    const tdAmt = document.createElement('td');
    tdAmt.className = 'amt';
    const inputAmt = document.createElement('input');
    inputAmt.type = 'text';
    inputAmt.className = 'input money';
    inputAmt.value = formatNumberWithDots(Math.round(preview[i - 1]?.monthlyPayment || 0));
    tdAmt.appendChild(inputAmt);

    tr.appendChild(tdYear);
    tr.appendChild(tdRate);
    tr.appendChild(tdAmt);
    tieredRatesTableBody.appendChild(tr);

    // === Saat bunga diubah ‚Üí update hanya angsuran tahun ini ===
    inputRate.addEventListener('input', () => {
      const rateVal = parseFloat(inputRate.value) || 0;
      const rates = Array.from(tieredRatesTableBody.querySelectorAll('input[type="number"]')).map(
        el => parseFloat(el.value) || 0
      );
      const newPreview = computeTieredPreview(rates, principal, years, extra);
      inputAmt.value = formatNumberWithDots(Math.round(newPreview[i - 1]?.monthlyPayment || 0));
    });

    // === Saat angsuran diubah ‚Üí hitung bunga yang cocok ===
    inputAmt.addEventListener('input', () => {
      const targetPayment = unfmt(inputAmt.value);
      if (!targetPayment || targetPayment <= 0) return;

      let balance = principal;
      for (let y = 1; y < i; y++) {
        const prevRate = parseFloat(tieredRatesTableBody.querySelectorAll('input[type="number"]')[y - 1].value) / 100 / 12;
        const remainMonths = Math.max(1, (years - y + 1) * 12);
        const prevPayment = prevRate === 0 ? balance / remainMonths : (prevRate * balance) / (1 - Math.pow(1 + prevRate, -remainMonths));
        for (let m = 0; m < 12 && balance > 0.01; m++) {
          const interest = balance * prevRate;
          const principalPay = prevPayment - interest + extra;
          balance = Math.max(0, balance - principalPay);
        }
      }

      // cari bunga yang sesuai untuk baris ini
      const remainingMonths = Math.max(1, (years - i + 1) * 12);
      let bestRate = 0;
      let minDiff = Infinity;
      for (let r = 0; r <= 25; r += 0.001) {
        const rMonthly = r / 100 / 12;
        const payment = rMonthly === 0
          ? balance / remainingMonths
          : (rMonthly * balance) / (1 - Math.pow(1 + rMonthly, -remainingMonths));
        const diff = Math.abs(payment - targetPayment);
        if (diff < minDiff) {
          minDiff = diff;
          bestRate = r;
        }
      }

      // update bunga baris ini saja
      inputRate.value = bestRate.toFixed(2);
      inputRate.style.backgroundColor = '#fff7cc';
      setTimeout(() => (inputRate.style.backgroundColor = ''), 600);
    });
  }

  attachMoneyInputs();
}


interestTypeEl.addEventListener('change', ()=>{
  const val = interestTypeEl.value;
  methodLabel.textContent = val === 'tiered' ? 'berjenjang' : 'flat';
  if(val === 'tiered'){
    generateTieredTable();
    tieredRatesContainer.style.display = 'block';
    setTimeout(()=>{ tieredRatesContainer.scrollIntoView({behavior:'smooth', block: 'center'}); }, 120);
  } else {
    tieredRatesContainer.style.display = 'none';
  }
});
yearsEl.addEventListener('change', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
priceEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
otherFeesEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });
extraEl.addEventListener('input', ()=>{ if(interestTypeEl.value==='tiered') generateTieredTable(); });

hideTieredBtn.addEventListener('click',(e)=>{ e.preventDefault(); tieredRatesContainer.style.display='none'; interestTypeEl.value='flat'; methodLabel.textContent='annuitas'; });

function handleCalculate(){
  const price = unfmt(priceEl.value);
  const dpVal = unfmt(dpValEl.value);
  const dpPct = parseFloat(dpPctEl.value) || 0;
  const years = parseInt(yearsEl.value) || 0;
  const rate = parseFloat(rateEl.value) || 0;
  const otherFees = unfmt(otherFeesEl.value);
  const extra = unfmt(extraEl.value);
  let dp = dpVal;
  if(!dp && dpPct && price) dp = Math.round(price * dpPct / 100);
  if(price && dp) dpPctEl.value = (dp / price * 100).toFixed(2);
  const principal = Math.max(0, price - dp + otherFees);
  const months = years * 12;
  if(principal<=0||months<=0){ alert("Pastikan semua input (harga, tenor, dll.) diisi dengan benar."); return; }

  let res;
  let baseRatesForResult = null;
  if(interestTypeEl.value === 'flat'){
    res = calcAmortization({ principal, annualRate: rate, months, extra });
    baseRatesForResult = Array(years).fill(rate);
  } else {
    const inputs = tieredRatesTableBody.querySelectorAll('input');
    let baseRates = Array.from(inputs).map(i=>parseFloat(i.value) || rate);
    while(baseRates.length < years) baseRates.push(baseRates[baseRates.length-1] || rate);
    baseRatesForResult = baseRates.slice(0, years);
    res = calcTieredAmortization({ principal, baseRates, years, extra });
  }
  renderResults(res);
  window._lastResult = {
    inputs:{ price, dp, years, rate, otherFees, extra, bank: bankEl.value, interestType: interestTypeEl.value, baseRates: baseRatesForResult },
    summary: { monthly: res.monthlyPayment, totalInterest: res.totalInterest, totalPayment: res.totalPayment, schedule: res.schedule }
  };
}
calcBtn.addEventListener('click', handleCalculate);

resetBtn.addEventListener('click', ()=>{
  priceEl.value='0'; dpValEl.value='0'; dpPctEl.value='20';
  yearsEl.value='15'; bankRates = loadBankRates(); populateBankSelect(); bankEl.value='BCA'; updateRateFromBank();
  otherFeesEl.value='0'; extraEl.value='0';
  interestTypeEl.value='flat'; methodLabel.textContent='annuitas'; tieredRatesContainer.style.display='none';
  summaryDiv.style.display='none'; amortTableBody.innerHTML=''; if(kprChart) kprChart.destroy();
});

downloadCsvBtn.addEventListener('click', ()=>{
  const rows = Array.from(amortTableBody.querySelectorAll('tr'));
  if(rows.length === 0){ alert('Tidak ada data. Silakan hitung terlebih dahulu.'); return; }
  const header = ['Bulan','Saldo awal','Angsuran pokok','Bunga','Saldo akhir'];
  const lines = [header.join(',')];
  rows.forEach(r=>{
    const tds = r.querySelectorAll('td');
    const month = tds[0].textContent.replace(/[^0-9]/g,'');
    const start = fmtRupiah(unfmt(tds[1].textContent));
    const pokok = fmtRupiah(unfmt(tds[2].textContent));
    const bunga = fmtRupiah(unfmt(tds[3].textContent));
    const end = fmtRupiah(unfmt(tds[4].textContent));
    lines.push([month,start,pokok,bunga,end].join(','));
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'amortisasi_kpr.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

exportImgBtn.addEventListener('click', async ()=>{
  if(!window._lastResult){ alert('Silakan hitung terlebih dahulu.'); return; }
  try {
    const container = document.createElement('div');
    container.style.padding='18px'; container.style.background='#fff'; container.style.width='900px'; container.style.boxSizing='border-box';
    const inputs = window._lastResult.inputs;
    container.innerHTML = `<h3 style="margin:0 0 10px 0">Simulasi KPR ‚Äî ${inputs.bank}</h3>
      <div style="margin-bottom:10px">
        <div>Pinjaman: ${fmtRupiah(inputs.price - inputs.dp + inputs.otherFees || 0)}</div>
        <div>Angsuran/bln (preview): ${fmtRupiah(window._lastResult.summary.monthly || 0)}</div>
        <div>Total bunga: ${fmtRupiah(window._lastResult.summary.totalInterest || 0)}</div>
      </div><div id="miniChartWrap" style="width:100%;height:260px"></div>`;
    document.body.appendChild(container);
    const miniCanvas = document.createElement('canvas');
    miniCanvas.width = 900; miniCanvas.height=260;
    container.querySelector('#miniChartWrap').appendChild(miniCanvas);
    const chartData = kprChart ? kprChart.data : { labels: [], datasets: [] };
    const miniChart = new Chart(miniCanvas.getContext('2d'), { type:'line', data: chartData, options:{ responsive:false, plugins:{ legend:{display:false} } }});
    const canvas = await html2canvas(container, { scale:2, useCORS:true, backgroundColor:'#fff' });
    miniChart.destroy(); container.remove();
    canvas.toBlob(async blob=>{
      if(!blob) return alert('Gagal membuat gambar.');
      const file = new File([blob], 'hasil_kpr.png', { type:'image/png' });
      if(navigator.canShare && navigator.canShare({ files: [file] })){
        try { await navigator.share({ files: [file], title: 'Hasil Simulasi KPR', text: 'Simulasi KPR ‚Äî Kalkulator Praktis' }); return; } catch(e){}
      }
      const url = canvas.toDataURL('image/png');
      const win = window.open();
      if(win){ win.document.write('<title>Hasil Simulasi</title><img src="'+url+'" style="width:100%;">'); }
      else { const a = document.createElement('a'); a.href=url; a.download='hasil_kpr.png'; a.click(); }
    }, 'image/png', 0.95);
  } catch(err){ console.error(err); alert('Gagal membuat gambar hasil. Gunakan browser terbaru (Chrome/Edge/Safari).'); }
});

shareTextBtn.addEventListener('click', ()=>{
  const d = window._lastResult;
  if(!d){ alert('Silakan hitung terlebih dahulu.'); return; }
  let txt = `üè† Simulasi KPR ‚Äî ${d.inputs.bank}\nHarga: ${fmtRupiah(d.inputs.price)}\nUang muka: ${fmtRupiah(d.inputs.dp)}\nTenor: ${d.inputs.years} tahun\n`;
  if(d.inputs.interestType === 'flat'){
    txt += `Suku bunga: ${d.inputs.rate}% (Flat)\nAngsuran/bln: ${fmtRupiah(d.summary.monthly)}\nTotal bunga: ${fmtRupiah(d.summary.totalInterest)}\nTotal bayar: ${fmtRupiah(d.summary.totalPayment)}\n`;
  } else {
    txt += `Jenis: Berjenjang (Floating)\n\n`;
    const schedule = d.summary.schedule || [];
    const years = d.inputs.years;
    const baseRates = d.inputs.baseRates || [];
    for(let y=1;y<=Math.min(years,25);y++){
      const startMonthIndex = (y-1)*12;
      if(startMonthIndex >= schedule.length) break;
      const row = schedule[startMonthIndex];
      const rateVal = (baseRates[y-1] != null) ? baseRates[y-1] : (baseRates[baseRates.length-1] || d.inputs.rate);
      const monthly = row ? (row.principalPayment + row.interestPayment) : 0;
      txt += `Tahun ${y}: ${Number(rateVal).toFixed(2)}% ‚Üí ${fmtRupiah(monthly)} /bln\n`;
    }
    txt += `\nTotal bunga: ${fmtRupiah(d.summary.totalInterest)}\nTotal bayar: ${fmtRupiah(d.summary.totalPayment)}\n`;
  }
  txt += `\nDibuat oleh Kalkulator Praktis`;
  const waUrl = 'https://wa.me/?text=' + encodeURIComponent(txt);
  window.open(waUrl, '_blank');
});

let tapCount=0,tapTimer=null;
logo.addEventListener('click', ()=>{
  tapCount++; if(tapTimer) clearTimeout(tapTimer); tapTimer = setTimeout(()=>{ tapCount=0; }, 800);
  if(tapCount>=3){ tapCount=0; openAdminModal(); }
});
function openAdminModal(){
  bankList.innerHTML='';
  Object.keys(bankRates).forEach(key=>{
    const row=document.createElement('div');row.className='bank-row';
    const label=document.createElement('div');label.style.width='90px';label.textContent=key;
    const input=document.createElement('input');input.type='number';input.step='0.01';input.className='input';input.value=bankRates[key]==null?'':String(bankRates[key]);input.dataset.key=key;
    const note=document.createElement('div');note.style.width='40px';note.style.fontSize='0.9rem';note.style.color='#475569';note.textContent='%';
    row.appendChild(label); row.appendChild(input); row.appendChild(note); bankList.appendChild(row);
  });
  modal.style.display='flex';
}
closeModalBtn.addEventListener('click', ()=> modal.style.display='none');
saveBanksBtn.addEventListener('click', ()=> {
  bankList.querySelectorAll('input').forEach(inp=>{
    bankRates[inp.dataset.key]=inp.value===''?null:Number(inp.value);
  });
  saveBankRates(bankRates);populateBankSelect();updateRateFromBank();modal.style.display='none';
  alert('Suku bunga disimpan.');
});
resetBanksBtn.addEventListener('click', ()=> {
  if(!confirm('Reset suku bunga ke default?'))return;
  bankRates={...defaultBankRates};saveBankRates(bankRates);populateBankSelect();updateRateFromBank();modal.style.display='none';
});

function loadFromHash(){
  try {
    const hash = location.hash.replace(/^#/,'');
    if(!hash) return;
    const params = new URLSearchParams(hash);
    if(params.get('price')) priceEl.value=params.get('price');
    if(params.get('dpVal')) dpValEl.value=params.get('dpVal');
    if(params.get('dpPct')) dpPctEl.value=params.get('dpPct');
    if(params.get('years')) yearsEl.value=params.get('years');
    if(params.get('rate')) rateEl.value=params.get('rate');
    if(params.get('bank')) { bankEl.value=params.get('bank'); updateRateFromBank(); }
    setTimeout(()=>{ handleCalculate(); }, 220);
  } catch(e){}
}

document.addEventListener('DOMContentLoaded', ()=>{
  populateBankSelect();
  bankEl.value='BCA';
  updateRateFromBank();
  attachMoneyInputs();
  loadFromHash();
});
</script>
</body>
</html>
