<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Kalkulator KPR Dhito</title>
  <style>
    :root {
      --blue-light: #b7dcff;
      --blue-mid: #3788f3;
      --blue-dark: #1e3c72;
      --glass-bg: rgba(255,255,255,0.7);
      --glass-blur: blur(10px);
      --radius: 14px;
      --shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
      background: linear-gradient(160deg, var(--blue-light), var(--blue-mid));
      min-height: 100vh;
      margin: 0;
      padding: 0;
      color: #1b1b1b;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    h1 {
      font-weight: 600;
      text-align: center;
      color: #fff;
      margin-top: 32px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    .card {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      width: min(95%, 600px);
      margin: 20px auto;
    }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 6px;
      font-weight: 500;
      color: #333;
    }

    .input, select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ddd;
      font-size: 1rem;
      box-sizing: border-box;
      margin-bottom: 14px;
    }

    .btn {
      display: inline-block;
      padding: 10px 18px;
      border: none;
      border-radius: 10px;
      background: var(--blue-mid);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s;
    }

    .btn:hover { background: var(--blue-dark); }

    .btn.ghost {
      background: transparent;
      border: 1px solid var(--blue-mid);
      color: var(--blue-mid);
    }

    .summary {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      font-size: 0.9rem;
    }

    table td, table th {
      padding: 6px 8px;
      border-bottom: 1px solid #e3e3e3;
    }

    .left { text-align: left; }
    .right { text-align: right; }

    /* Modal admin */
    .modal {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.3);
      display: none;
      justify-content: center; align-items: center;
      z-index: 10;
    }

    .modal .inner {
      background: var(--glass-bg);
      backdrop-filter: var(--glass-blur);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      width: min(90%, 400px);
    }

    .bank-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 8px 0;
    }

    @media (max-width: 600px) {
      .card { padding: 16px; }
      table { font-size: 0.8rem; }
      .btn { width: 100%; text-align: center; }
    }
  </style>

  <!-- Chart & HTML2Canvas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
</head>

<body>
  <h1 id="logo">üè¶ Kalkulator KPR Dhito</h1>

  <div class="card">
    <label>Bank</label>
    <select id="bank"></select>

    <label>Suku Bunga (%)</label>
    <input type="number" id="rate" class="input">

    <label>Harga Rumah</label>
    <input id="price" class="input money" placeholder="Rp">

    <label>Uang Muka (nominal)</label>
    <input id="dpVal" class="input money" placeholder="Rp">

    <label>atau (%)</label>
    <input id="dpPct" class="input" placeholder="contoh: 10">

    <label>Tenor (tahun)</label>
    <input type="number" id="years" class="input" placeholder="15">

    <label>Biaya lain-lain</label>
    <input id="otherFees" class="input money" placeholder="Rp">

    <label>Tambahan angsuran/bln</label>
    <input id="extra" class="input money" placeholder="Rp">

    <button id="calcBtn" class="btn" style="width:100%;margin-top:10px;">Hitung</button>

    <div id="summary" class="summary" style="display:none;">
      <div>üí∞ Pinjaman: <b id="loanAmt"></b></div>
      <div>üìÖ Angsuran/bln: <b id="monthly"></b></div>
      <div>üí∏ Total Bunga: <b id="totalInterest"></b></div>

      <canvas id="kprChart" height="200"></canvas>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;">
        <button id="exportImg" class="btn">Ekspor Gambar</button>
        <button id="downloadCsv" class="btn ghost">Ekspor CSV</button>
        <button id="shareText" class="btn ghost">Bagikan WhatsApp</button>
      </div>

      <table id="amortTable">
        <thead><tr><th>Bulan</th><th>Saldo Awal</th><th>Pokok</th><th>Bunga</th><th>Saldo Akhir</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ADMIN modal -->
  <div id="modal" class="modal">
    <div class="inner">
      <h3>Kelola Suku Bunga Bank</h3>
      <div id="bankList"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button id="saveBanks" class="btn">Simpan</button>
        <button id="resetBanks" class="btn ghost">Reset Default</button>
        <button id="closeModal" class="btn ghost">Tutup</button>
      </div>
    </div>
  </div>

<script>
/* === UTILITAS FORMAT UANG === */
function fmtRupiah(n){
  if(!isFinite(n)) return 'Rp 0';
  const sign = n < 0 ? '-' : '';
  n = Math.abs(Math.round(n));
  return sign + 'Rp ' + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function unfmt(v){ return Number(String(v||'').replace(/[^\d\-]/g, '')) || 0; }
function formatNumberWithDots(v){ return v.replace(/\D/g,'').replace(/\B(?=(\d{3})+(?!\d))/g,'.'); }
function attachMoneyInputs(){
  document.querySelectorAll('.money').forEach(el=>{
    el.value = formatNumberWithDots(el.value);
    el.addEventListener('input',()=>{
      const pos=el.selectionStart, before=el.value.length;
      el.value=formatNumberWithDots(el.value);
      el.selectionEnd=pos+(el.value.length-before);
    });
  });
}

/* === DATA SUKU BUNGA BANK === */
const defaultBankRates = { BCA:7.25, BTN:6.9, BRI:7.1, MANDIRI:7.5, BNI:7.4, OCBC:7.0, BSI:0, CUSTOM:null };
const storageKey='kpr_bank_rates_v3';
function loadBankRates(){ try{ return {...defaultBankRates,...JSON.parse(localStorage.getItem(storageKey)||'{}')} }catch{return {...defaultBankRates}}}
function saveBankRates(m){ localStorage.setItem(storageKey,JSON.stringify(m)); }
let bankRates = loadBankRates();

/* === ELEMENTS === */
const bankEl=document.getElementById('bank'), rateEl=document.getElementById('rate'),
      priceEl=document.getElementById('price'), dpValEl=document.getElementById('dpVal'),
      dpPctEl=document.getElementById('dpPct'), yearsEl=document.getElementById('years'),
      otherFeesEl=document.getElementById('otherFees'), extraEl=document.getElementById('extra'),
      summaryDiv=document.getElementById('summary'), loanAmtEl=document.getElementById('loanAmt'),
      monthlyEl=document.getElementById('monthly'), totalInterestEl=document.getElementById('totalInterest'),
      amortTableBody=document.querySelector('#amortTable tbody'),
      calcBtn=document.getElementById('calcBtn'), exportImgBtn=document.getElementById('exportImg'),
      downloadCsvBtn=document.getElementById('downloadCsv'), shareTextBtn=document.getElementById('shareText'),
      logo=document.getElementById('logo'), modal=document.getElementById('modal'), bankList=document.getElementById('bankList');

let kprChart=null;

/* === BANK SELECT === */
function populateBankSelect(){
  bankEl.innerHTML='';
  for(const [k,v] of Object.entries(bankRates)){
    const o=document.createElement('option');
    o.value=k;
    o.textContent=k+(v!==null?' ‚Äî '+v+'%':' ‚Äî Custom');
    bankEl.appendChild(o);
  }
}
function updateRateFromBank(){
  const b=bankEl.value,v=bankRates[b];
  if(v==null) rateEl.removeAttribute('readonly');
  else { rateEl.value=v; rateEl.setAttribute('readonly','true'); }
}
populateBankSelect(); updateRateFromBank();
bankEl.addEventListener('change',updateRateFromBank);

/* === DP SYNC === */
dpPctEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value), pct=parseFloat(dpPctEl.value)||0;
  dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));
});
dpValEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value), dp=unfmt(dpValEl.value);
  dpPctEl.value=((dp/price)*100||0).toFixed(2);
});
priceEl.addEventListener('input',()=>{
  const price=unfmt(priceEl.value), pct=parseFloat(dpPctEl.value)||0;
  dpValEl.value=formatNumberWithDots(String(Math.round(price*pct/100)));
});
attachMoneyInputs();

/* === PERHITUNGAN === */
function calcAmortization({principal,annualRate,months,extra=0}){
  const r=annualRate/12/100;
  const baseMonthly = r===0 ? principal/months : (r*principal)/(1-Math.pow(1+r,-months));
  let bal=principal,totalInterest=0,schedule=[];
  for(let m=1;m<=months&&bal>0;m++){
    const interest=bal*r;
    let principalPay=baseMonthly-interest+extra;
    if(principalPay>bal) principalPay=bal;
    const endBal=bal-principalPay;
    schedule.push({month:m,startBalance:bal,principalPayment:principalPay,interestPayment:interest,endBalance:endBal});
    totalInterest+=interest; bal=endBal;
  }
  return {schedule,monthlyPayment:baseMonthly+extra,totalInterest,principal};
}

/* === HITUNG === */
function handleCalculate(){
  const price=unfmt(priceEl.value),
        dpVal=unfmt(dpValEl.value),
        dpPct=parseFloat(dpPctEl.value)||0,
        years=parseInt(yearsEl.value)||0,
        rate=parseFloat(rateEl.value)||0,
        otherFees=unfmt(otherFeesEl.value),
        extra=unfmt(extraEl.value);
  let dp=dpVal; if(!dp&&dpPct>=0) dp=Math.round(price*dpPct/100);
  const principal=Math.max(0,price-dp+otherFees), months=years*12;
  if(principal<=0||months<=0){ alert('Pastikan input benar.'); return; }
  const res=calcAmortization({principal,annualRate:rate,months,extra});
  renderResults(res);
  window._lastResult={inputs:{price,dp,years,rate,otherFees,extra,bank:bankEl.value},summary:res};
}
calcBtn.onclick=handleCalculate;

/* === RENDER HASIL === */
function renderResults(res){
  summaryDiv.style.display='flex';
  loanAmtEl.textContent=fmtRupiah(res.principal);
  monthlyEl.textContent=fmtRupiah(res.monthlyPayment);
  totalInterestEl.textContent=fmtRupiah(res.totalInterest);
  amortTableBody.innerHTML='';
  const labels=[],balSeries=[],intSeries=[],pokokSeries=[];
  res.schedule.forEach(r=>{
    labels.push(r.month);
    balSeries.push(r.endBalance);
    intSeries.push(r.interestPayment);
    pokokSeries.push(r.principalPayment);
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="left">#${r.month}</td><td>${fmtRupiah(r.startBalance)}</td><td>${fmtRupiah(r.principalPayment)}</td><td>${fmtRupiah(r.interestPayment)}</td><td class="left">${fmtRupiah(r.endBalance)}</td>`;
    amortTableBody.appendChild(tr);
  });
  if(kprChart) kprChart.destroy();
  kprChart=new Chart(document.getElementById('kprChart'),{
    type:'line',
    data:{labels,datasets:[
      {label:'Saldo Akhir',data:balSeries,borderWidth:2,tension:.2},
      {label:'Bunga/bln',data:intSeries,borderWidth:2,tension:.2},
      {label:'Pokok/bln',data:pokokSeries,borderWidth:2,tension:.2}
    ]},
    options:{maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:{callbacks:{label:c=>c.dataset.label+': '+fmtRupiah(c.raw)}}}}
  });
}

/* === EKSPOR GAMBAR (DENGAN GRADIENT) === */
exportImgBtn.onclick=async()=>{
  if(!window._lastResult){ alert('Hitung dulu.'); return; }
  const resultCard = document.querySelector('.card');
  const canvas = await html2canvas(resultCard,{scale:2,useCORS:true,backgroundColor:null});
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = canvas.width;
  tempCanvas.height = canvas.height;
  const ctx = tempCanvas.getContext('2d');
  const gradient = ctx.createLinearGradient(0,0,0,tempCanvas.height);
  gradient.addColorStop(0,'#b7dcff');
  gradient.addColorStop(1,'#3788f3');
  ctx.fillStyle = gradient;
  ctx.fillRect(0,0,tempCanvas.width,tempCanvas.height);
  ctx.drawImage(canvas,0,0);
  tempCanvas.toBlob(async blob=>{
    const file=new File([blob],'hasil_kpr.png',{type:'image/png'});
    if(navigator.canShare&&navigator.canShare({files:[file]})){
      await navigator.share({files:[file],title:'Hasil KPR',text:'Simulasi KPR ‚Äî Kalkulator KPR Dhito'});
    }else{
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='hasil_kpr.png';a.click();
    }
  });
};

/* === EKSPOR CSV === */
downloadCsvBtn.onclick=()=>{
  const rows=[['Bulan','Saldo Awal','Pokok','Bunga','Saldo Akhir']];
  amortTableBody.querySelectorAll('tr').forEach(tr=>{
    const t=[...tr.children].map(td=>td.textContent.trim());
    rows.push(t);
  });
  const csv=rows.map(r=>r.join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='amortisasi_kpr.csv';a.click();
};

/* === SHARE WHATSAPP TEXT === */
const deployLink='https://dhitoid.github.io/Kalkulator-KPR-Dhito/';
function buildShareText(){
  const d=window._lastResult;
  if(!d)return `Simulasi KPR ‚Äî ${deployLink}`;
  return `üè† Simulasi KPR ‚Äî Kalkulator Dhito\nBank: ${d.inputs.bank}\nHarga: ${fmtRupiah(d.inputs.price)}\nUang muka: ${fmtRupiah(d.inputs.dp)}\nTenor: ${d.inputs.years} tahun\nSuku bunga: ${d.inputs.rate}%\n\nAngsuran/bln: ${fmtRupiah(d.summary.monthlyPayment)}\nTotal bunga: ${fmtRupiah(d.summary.totalInterest)}\n\nCoba di ${deployLink}`;
}
shareTextBtn.onclick=()=>window.open('https://wa.me/?text='+encodeURIComponent(buildShareText()),'_blank');

/* === ADMIN (TRIPLE TAP LOGO) === */
let tap=0,timer=null;
logo.onclick=()=>{
  tap++; clearTimeout(timer);
  timer=setTimeout(()=>tap=0,600);
  if(tap>=3){ tap=0; openAdmin(); }
};
function openAdmin(){
  bankList.innerHTML='';
  for(const [k,v] of Object.entries(bankRates)){
    const div=document.createElement('div');div.className='bank-row';
    div.innerHTML=`<div style="width:90px">${k}</div><input type="number" step="0.01" class="input" data-key="${k}" value="${v??''}" placeholder="0"><div style="width:40px;color:#555">%</div>`;
    bankList.appendChild(div);
  }
  modal.style.display='flex';
}
document.getElementById('closeModal').onclick=()=>modal.style.display='none';
document.getElementById('saveBanks').onclick=()=>{
  bankList.querySelectorAll('input').forEach(inp=>{
    const key=inp.dataset.key; const val=inp.value===''?null:Number(inp.value);
    bankRates[key]=val;
  });
  saveBankRates(bankRates); populateBankSelect(); updateRateFromBank(); modal.style.display='none';
  alert('Suku bunga disimpan.');
};
document.getElementById('resetBanks').onclick=()=>{
  if(confirm('Reset default?')){ bankRates={...defaultBankRates}; saveBankRates(bankRates); populateBankSelect(); updateRateFromBank(); modal.style.display='none'; }
};
</script>

</body>
</html>
